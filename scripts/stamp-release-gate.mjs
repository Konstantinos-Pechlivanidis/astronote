#!/usr/bin/env node

/**
 * Release Gate Pass Stamp Script
 * 
 * Generates stamp files when release gate passes:
 * - reports/release-gate-pass.json (machine-readable)
 * - reports/release-gate-pass.md (human-readable)
 * 
 * These files are gitignored and should never be committed.
 */

import { writeFileSync, mkdirSync, existsSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const ROOT = join(__dirname, '..');
const REPORTS_DIR = join(ROOT, 'reports');
const JSON_STAMP = join(REPORTS_DIR, 'release-gate-pass.json');
const MD_STAMP = join(REPORTS_DIR, 'release-gate-pass.md');

// Ensure reports directory exists
if (!existsSync(REPORTS_DIR)) {
  try {
    mkdirSync(REPORTS_DIR, { recursive: true });
  } catch (error) {
    console.error('❌ Failed to create reports directory:', error.message);
    process.exit(1);
  }
}

// Generate timestamp
const timestamp = new Date().toISOString();
const date = new Date();
const dateStr = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
  timeZoneName: 'short',
});

// JSON stamp (machine-readable)
const jsonStamp = {
  passed: true,
  timestamp,
  date: dateStr,
  message: 'Release gate passed successfully',
  version: '1.0.0',
};

// Markdown stamp (human-readable)
const mdStamp = `# Release Gate Pass Stamp

**Status:** ✅ **PASSED**

**Date:** ${dateStr}  
**Timestamp:** ${timestamp}

## Summary

All release gate checks have passed successfully.

- ✅ All audits passed
- ✅ All builds passed
- ✅ Code is ready for deployment

---

*This file is automatically generated by \`npm run stamp:release:gate\` and should not be committed to git.*
`;

try {
  // Write JSON stamp
  writeFileSync(JSON_STAMP, JSON.stringify(jsonStamp, null, 2), 'utf8');
  console.log(`✅ Generated: ${JSON_STAMP}`);

  // Write Markdown stamp
  writeFileSync(MD_STAMP, mdStamp, 'utf8');
  console.log(`✅ Generated: ${MD_STAMP}`);

  console.log('\n✅ Release gate pass stamp files generated successfully');
  process.exit(0);
} catch (error) {
  console.error('❌ Failed to write stamp files:', error.message);
  process.exit(1);
}

